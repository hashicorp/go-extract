name: Security scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  sec_scan:
    runs-on: ubuntu-latest

    steps:
      - name: "Setup Go"
        uses: actions/setup-go@cdcb36043654635271a94b9a6d1392de5bb323a7 # v5.0.1
        with:
          go-version-file: "go.mod"
          cache: false

      - name: Clone Security Scanner Repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          repository: hashicorp/security-scanner
          token: ${{ secrets.PRODSEC_SCANNER_READ_ONLY }}
          path: security-scanner
      
      - name: Clone go-extract Repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      
      - name: Scan Repository
        uses: hashicorp/security-scanner@main
        with:
          repository: ${{ github.workspace }} 
          config: |
            repository {
              osv        = true
              secrets {
                all = true
              } 
            }
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@f9a7c6738f28efb36e31d49c53a201a9c5d6a476 # codeql-bundle-v2.14.2
        with:
          sarif_file: results.sarif
